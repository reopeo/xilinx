#include <stdio.h>
#include <stdlib.h>
#include "xil_printf.h"
#include "xparameters.h"
#include "xcnn_top.h"
#include "xtime_l.h"

XCnn_top Instance;

extern const float weight0[4][1][3][3];
extern const float bias0[4];
extern const float weight1[8][4][3][3];
extern const float bias1[8];
extern const float weight2[32][8*7*7];
extern const float bias2[32];
extern const float weight3[10][32];
extern const float bias3[10];

int main()
{
	XTime tStart, tEnd;

    float x[1][28][28]={{{0.0 , 0.0 , 0.0 , 0.0 , 0.0 , 0.0 , 0.0 , 0.0 , 0.0 , 0.0 , 0.0 , 0.0 , 0.0 , 0.0 , 0.0 , 0.0 , 0.0 , 0.0 , 0.0 , 0.0 , 0.0 , 0.0 , 0.0 , 0.0 , 0.0 , 0.0 , 0.0 , 0.0  } ,
    		{0.0 , 0.0 , 0.0 , 0.0 , 0.0 , 0.0 , 0.0 , 0.0 , 0.0 , 0.0 , 0.0 , 0.0 , 0.0 , 0.0 , 0.0 , 0.0 , 0.0 , 0.0 , 0.0 , 0.0 , 0.0 , 0.0 , 0.0 , 0.0 , 0.0 , 0.0 , 0.0 , 0.0  } ,
    		{0.0 , 0.0 , 0.0 , 0.0 , 0.0 , 0.0 , 0.0 , 0.0 , 0.0 , 0.0 , 0.0 , 0.0 , 0.0 , 0.0 , 0.0 , 0.0 , 0.0 , 0.0 , 0.0 , 0.0 , 0.0 , 0.0 , 0.0 , 0.0 , 0.0 , 0.0 , 0.0 , 0.0  } ,
    		{0.0 , 0.0 , 0.0 , 0.0 , 0.0 , 0.0 , 0.0 , 0.0 , 0.0 , 0.0 , 0.0 , 0.0 , 0.0 , 0.0 , 0.0 , 0.0 , 0.0 , 0.0 , 0.0 , 0.0 , 0.0 , 0.0 , 0.0 , 0.0 , 0.0 , 0.0 , 0.0 , 0.0  } ,
    		{0.0 , 0.0 , 0.0 , 0.0 , 0.0 , 0.0 , 0.0 , 0.0 , 0.0 , 0.0 , 0.0 , 0.0 , 0.0 , 0.0 , 0.0 , 0.0 , 0.0 , 0.0 , 0.0 , 0.0 , 0.0 , 0.0 , 0.0 , 0.0 , 0.0 , 0.0 , 0.0 , 0.0  } ,
    		{0.0 , 0.0 , 0.0 , 0.0 , 0.0 , 0.0 , 0.0 , 0.0 , 0.0 , 0.0 , 0.0 , 0.14901961 , 0.16862746 , 0.4117647 , 1.0 , 0.99215686 , 0.99215686 , 0.99215686 , 0.99215686 , 0.99215686 , 0.68235296 , 0.023529412 , 0.0 , 0.0 , 0.0 , 0.0 , 0.0 , 0.0  } ,
    		{0.0 , 0.0 , 0.0 , 0.0 , 0.0 , 0.0 , 0.0 , 0.0 , 0.0 , 0.16862746 , 0.54509807 , 0.8784314 , 0.8862745 , 0.9882353 , 0.99215686 , 0.9882353 , 0.9882353 , 0.9882353 , 0.9882353 , 0.9882353 , 0.9882353 , 0.61960787 , 0.05490196 , 0.0 , 0.0 , 0.0 , 0.0 , 0.0  } ,
    		{0.0 , 0.0 , 0.0 , 0.0 , 0.0 , 0.0 , 0.0 , 0.0 , 0.0 , 0.69803923 , 0.9882353 , 0.9882353 , 0.9882353 , 0.9882353 , 0.99215686 , 0.9882353 , 0.9882353 , 0.9882353 , 0.9882353 , 0.9882353 , 0.9882353 , 0.9882353 , 0.23137255 , 0.0 , 0.0 , 0.0 , 0.0 , 0.0  } ,
    		{0.0 , 0.0 , 0.0 , 0.0 , 0.0 , 0.0 , 0.0 , 0.0 , 0.0 , 0.42745098 , 0.9882353 , 0.9882353 , 0.9019608 , 0.5176471 , 0.52156866 , 0.5176471 , 0.5176471 , 0.7411765 , 0.9882353 , 0.9882353 , 0.9882353 , 0.9882353 , 0.23137255 , 0.0 , 0.0 , 0.0 , 0.0 , 0.0  } ,
    		{0.0 , 0.0 , 0.0 , 0.0 , 0.0 , 0.0 , 0.0 , 0.0 , 0.0 , 0.015686275 , 0.11372549 , 0.11372549 , 0.09411765 , 0.0 , 0.0 , 0.0 , 0.0 , 0.05490196 , 0.8862745 , 0.9882353 , 0.9882353 , 0.6745098 , 0.02745098 , 0.0 , 0.0 , 0.0 , 0.0 , 0.0  } ,
    		{0.0 , 0.0 , 0.0 , 0.0 , 0.0 , 0.0 , 0.0 , 0.0 , 0.0 , 0.0 , 0.0 , 0.0 , 0.0 , 0.0 , 0.0 , 0.0 , 0.0 , 0.33333334 , 0.9529412 , 0.9882353 , 0.9882353 , 0.5647059 , 0.0 , 0.0 , 0.0 , 0.0 , 0.0 , 0.0  } ,
    		{0.0 , 0.0 , 0.0 , 0.0 , 0.0 , 0.0 , 0.0 , 0.0 , 0.0 , 0.0 , 0.0 , 0.0 , 0.0 , 0.0 , 0.0 , 0.0 , 0.34509805 , 0.7411765 , 0.9882353 , 0.9882353 , 0.9882353 , 0.05490196 , 0.0 , 0.0 , 0.0 , 0.0 , 0.0 , 0.0  } ,
    		{0.0 , 0.0 , 0.0 , 0.0 , 0.0 , 0.0 , 0.0 , 0.0 , 0.0 , 0.0 , 0.0 , 0.0 , 0.0 , 0.0 , 0.35686275 , 0.83137256 , 0.96862745 , 0.9882353 , 0.9882353 , 0.9882353 , 0.8 , 0.03529412 , 0.0 , 0.0 , 0.0 , 0.0 , 0.0 , 0.0  } ,
    		{0.0 , 0.0 , 0.0 , 0.0 , 0.0 , 0.0 , 0.0 , 0.0 , 0.0 , 0.1254902 , 0.49019608 , 0.75686276 , 0.75686276 , 0.75686276 , 0.99215686 , 0.9882353 , 0.9882353 , 0.9882353 , 0.93333334 , 0.4 , 0.10980392 , 0.0 , 0.0 , 0.0 , 0.0 , 0.0 , 0.0 , 0.0  } ,
    		{0.0 , 0.0 , 0.0 , 0.0 , 0.0 , 0.0 , 0.0 , 0.0 , 0.1764706 , 0.87058824 , 0.9882353 , 0.9882353 , 0.9882353 , 0.9882353 , 0.99215686 , 0.9882353 , 0.9882353 , 0.9882353 , 0.69411767 , 0.0 , 0.0 , 0.0 , 0.0 , 0.0 , 0.0 , 0.0 , 0.0 , 0.0  } ,
    		{0.0 , 0.0 , 0.0 , 0.0 , 0.0 , 0.0 , 0.0 , 0.0 , 0.1764706 , 0.8745098 , 0.99215686 , 0.99215686 , 0.99215686 , 0.99215686 , 1.0 , 0.99215686 , 0.99215686 , 0.99215686 , 0.99215686 , 0.2901961 , 0.0 , 0.0 , 0.0 , 0.0 , 0.0 , 0.0 , 0.0 , 0.0  } ,
    		{0.0 , 0.0 , 0.0 , 0.0 , 0.0 , 0.0 , 0.0 , 0.0 , 0.0 , 0.12156863 , 0.48235294 , 0.20392157 , 0.17254902 , 0.17254902 , 0.17254902 , 0.17254902 , 0.56078434 , 0.9882353 , 0.9882353 , 0.2901961 , 0.0 , 0.0 , 0.0 , 0.0 , 0.0 , 0.0 , 0.0 , 0.0  } ,
    		{0.0 , 0.0 , 0.0 , 0.0 , 0.0 , 0.0 , 0.0 , 0.0 , 0.0 , 0.0 , 0.0 , 0.0 , 0.0 , 0.0 , 0.0 , 0.0 , 0.05882353 , 0.9882353 , 0.9882353 , 0.2901961 , 0.0 , 0.0 , 0.0 , 0.0 , 0.0 , 0.0 , 0.0 , 0.0  } ,
    		{0.0 , 0.0 , 0.0 , 0.0 , 0.0 , 0.0 , 0.0 , 0.0 , 0.0 , 0.0 , 0.0 , 0.0 , 0.0 , 0.0 , 0.0 , 0.0 , 0.3372549 , 0.9882353 , 0.9882353 , 0.2901961 , 0.0 , 0.0 , 0.0 , 0.0 , 0.0 , 0.0 , 0.0 , 0.0  } ,
    		{0.0 , 0.0 , 0.0 , 0.0 , 0.0 , 0.0 , 0.019607844 , 0.29411766 , 0.03529412 , 0.0 , 0.0 , 0.0 , 0.0 , 0.0 , 0.0 , 0.38431373 , 0.9490196 , 0.9882353 , 0.9882353 , 0.2901961 , 0.0 , 0.0 , 0.0 , 0.0 , 0.0 , 0.0 , 0.0 , 0.0  } ,
    		{0.0 , 0.0 , 0.0 , 0.0 , 0.0 , 0.23921569 , 0.7176471 , 0.9882353 , 0.11372549 , 0.0 , 0.0 , 0.0 , 0.0 , 0.07058824 , 0.36078432 , 0.9372549 , 0.9882353 , 0.9882353 , 0.9529412 , 0.25490198 , 0.0 , 0.0 , 0.0 , 0.0 , 0.0 , 0.0 , 0.0 , 0.0  } ,
    		{0.0 , 0.0 , 0.0 , 0.0 , 0.0 , 0.8156863 , 0.9882353 , 0.9882353 , 0.5764706 , 0.5254902 , 0.5254902 , 0.5254902 , 0.5254902 , 0.79607844 , 0.99215686 , 0.9882353 , 0.9882353 , 0.7372549 , 0.3254902 , 0.0 , 0.0 , 0.0 , 0.0 , 0.0 , 0.0 , 0.0 , 0.0 , 0.0  } ,
    		{0.0 , 0.0 , 0.0 , 0.0 , 0.0 , 0.8156863 , 0.9882353 , 0.9882353 , 0.9882353 , 0.9882353 , 0.9882353 , 0.9882353 , 0.9882353 , 0.9882353 , 0.99215686 , 0.9019608 , 0.6 , 0.03137255 , 0.0 , 0.0 , 0.0 , 0.0 , 0.0 , 0.0 , 0.0 , 0.0 , 0.0 , 0.0  } ,
    		{0.0 , 0.0 , 0.0 , 0.0 , 0.0 , 0.19215687 , 0.6156863 , 0.9882353 , 0.9882353 , 0.9882353 , 0.9882353 , 0.9882353 , 0.8509804 , 0.8117647 , 0.57254905 , 0.1764706 , 0.0 , 0.0 , 0.0 , 0.0 , 0.0 , 0.0 , 0.0 , 0.0 , 0.0 , 0.0 , 0.0 , 0.0  } ,
    		{0.0 , 0.0 , 0.0 , 0.0 , 0.0 , 0.0 , 0.02745098 , 0.40392157 , 0.92156863 , 0.9882353 , 0.6745098 , 0.40392157 , 0.09411765 , 0.0 , 0.0 , 0.0 , 0.0 , 0.0 , 0.0 , 0.0 , 0.0 , 0.0 , 0.0 , 0.0 , 0.0 , 0.0 , 0.0 , 0.0  } ,
    		{0.0 , 0.0 , 0.0 , 0.0 , 0.0 , 0.0 , 0.0 , 0.0 , 0.0 , 0.0 , 0.0 , 0.0 , 0.0 , 0.0 , 0.0 , 0.0 , 0.0 , 0.0 , 0.0 , 0.0 , 0.0 , 0.0 , 0.0 , 0.0 , 0.0 , 0.0 , 0.0 , 0.0  } ,
    		{0.0 , 0.0 , 0.0 , 0.0 , 0.0 , 0.0 , 0.0 , 0.0 , 0.0 , 0.0 , 0.0 , 0.0 , 0.0 , 0.0 , 0.0 , 0.0 , 0.0 , 0.0 , 0.0 , 0.0 , 0.0 , 0.0 , 0.0 , 0.0 , 0.0 , 0.0 , 0.0 , 0.0  } ,
    		{0.0 , 0.0 , 0.0 , 0.0 , 0.0 , 0.0 , 0.0 , 0.0 , 0.0 , 0.0 , 0.0 , 0.0 , 0.0 , 0.0 , 0.0 , 0.0 , 0.0 , 0.0 , 0.0 , 0.0 , 0.0 , 0.0 , 0.0 , 0.0 , 0.0 , 0.0 , 0.0 , 0.0  } , }};
    float y[10]={0};

    printf("START FPGA.\n");

    if(XCnn_top_Initialize(&Instance, XPAR_CNN_TOP_0_DEVICE_ID) != XST_SUCCESS)
    {
        xil_printf("Init Error!\n");
        return XST_FAILURE;
    }

    XCnn_top_Write_x_Words(&Instance, 0, x, 28*28);
    XCnn_top_Write_weight0_Words(&Instance, 0, weight0, 4*1*3*3);
    XCnn_top_Write_bias0_Words(&Instance, 0, bias0, 4);
    XCnn_top_Write_weight1_Words(&Instance, 0, weight1, 8*4*3*3);
    XCnn_top_Write_bias1_Words(&Instance, 0, bias1, 8);
    XCnn_top_Write_weight2_Words(&Instance, 0, weight2, 32*8*7*7);
    XCnn_top_Write_bias2_Words(&Instance, 0, bias2, 32);
    XCnn_top_Write_weight3_Words(&Instance, 0, weight3, 10*32);
    XCnn_top_Write_bias3_Words(&Instance, 0, bias3, 10);
    XCnn_top_Write_y_Words(&Instance, 0, y, 10);

    XTime_GetTime(&tStart);
    XCnn_top_Start(&Instance);
    while(XCnn_top_IsDone(&Instance) == 0);
    XTime_GetTime(&tEnd);

    XCnn_top_Read_y_Words(&Instance, 0, y, 10);

    printf("Output took %llu clock cycles.\n", 2 * (tEnd - tStart));
    printf("Output took %.2lf us.\n", 1.0 * (tEnd - tStart) / (COUNTS_PER_SECOND / 100000000));

    printf("Result is\n");
    for(int i=0; i<10; i++)
    	printf("%lf ",y[i]);

    printf("\nDONE.\n");

    return 0;
}
